const builder=e=>{let t,s,o,n,c;e=e.promise||e;let a=0;let r,l=0,i=0;let u,d=0;let m=0;const p=(t,n,c,f)=>{(async t=>!l||d<l?(l&&(d++,setTimeout(()=>{d--,u=null},i)),u=e(...t)):o?u:Promise.reject({code:429,message:"Too many requests",value:await u}))(t).then(e=>{a&&(r=e,setTimeout(()=>r=null,a)),s=null,n(e)}).catch(e=>{f<m?p(t,n,c,f+1):(s=null,c(e))})};let f=0;let h;const y={promise:async(...e)=>{if(r)return r;let o,a;return t=new Promise((e,t)=>{o=e,a=t}),s?c?o(s):a({code:102,message:"Async request already in progress",value:await s}):((e,o,c)=>{if(f){const a=t;h=t,setTimeout(async()=>{h!==a?n?o(h):c({code:409,message:"Async request be debounced",value:await h}):(h=null,s=a,p(e,o,c,0))},f)}else s=t,p(e,o,c,0)})(e,o,a),t},allow:(...e)=>(o=e.includes(429),n=e.includes(409),c=e.includes(102),y),cache:e=>(a=e,y),debounce:e=>(f=e,y),retries:e=>(m=e,y),throttle:(e,t)=>(l=e,i=t,y)};return y},dag=()=>{const e=new Map,t=e=>"function"==typeof e,s=async(e,o,n,c,a,r,l)=>{(r.length?l(...await Promise.all(r)):l()).then(i=>{n.set(r,i),--a[0]||e([...n.values()].pop());const u=c.get(l);if(u)for(const r of u)r[r.indexOf(l)]=i,r.every(e=>!t(e))&&s(e,o,n,c,a,r,n.get(r)).catch(e=>o(e))}).catch(e=>o(e))},o={promise:()=>new Promise((o,n)=>{const c=new Map,a=new Map;for(const[s,o]of e){const e=[...s];c.set(e,o);for(const s of e)t(s)&&(a.has(s)?a.get(s).push(e):a.set(s,[e]))}const r=[c.size];for(const[e,l]of c)e.every(e=>!t(e))&&s(o,n,c,a,r,e,l).catch(e=>n(e))}),add:(t,...s)=>(e.set(s.map(e=>e.promise||e),t.promise||t),o)};return o};export{builder,dag};